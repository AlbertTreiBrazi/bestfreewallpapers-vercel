Deno.serve(async (req) => {
    const corsHeaders = {
        'Access-Control-Allow-Origin': 'https://jfsmnwjifcq3.space.minimax.io',
        'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
        'Access-Control-Allow-Methods': 'GET, POST, PUT, OPTIONS',
        'Access-Control-Max-Age': '86400',
        'Access-Control-Allow-Credentials': 'false'
    };

    if (req.method === 'OPTIONS') {
        return new Response(null, { status: 200, headers: corsHeaders });
    }

    try {
        const serviceRoleKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY');
        const supabaseUrl = Deno.env.get('SUPABASE_URL');
        const supabaseAnonKey = Deno.env.get('SUPABASE_ANON_KEY');

        if (!serviceRoleKey || !supabaseUrl || !supabaseAnonKey) {
            throw new Error('Supabase configuration missing');
        }

        // Verify admin authentication
        const authHeader = req.headers.get('authorization');
        if (!authHeader) {
            throw new Error('Authentication required');
        }

        const token = authHeader.replace('Bearer ', '');
        const userResponse = await fetch(`${supabaseUrl}/auth/v1/user`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'apikey': supabaseAnonKey
            }
        });

        if (!userResponse.ok) {
            throw new Error('Invalid authentication token');
        }

        const userData = await userResponse.json();
        const userId = userData.id;

        // Check if user is admin
        const profileResponse = await fetch(`${supabaseUrl}/rest/v1/profiles?user_id=eq.${userId}&select=is_admin`, {
            headers: {
                'Authorization': `Bearer ${serviceRoleKey}`,
                'apikey': serviceRoleKey
            }
        });

        if (!profileResponse.ok) {
            throw new Error('Failed to verify admin status');
        }

        const profiles = await profileResponse.json();
        const profile = profiles[0];

        if (!profile || !profile.is_admin) {
            throw new Error('Admin access required');
        }

        const url = new URL(req.url);
        const action = url.searchParams.get('action') || 'list';

        if (req.method === 'GET' && action === 'list') {
            // Get all rate limit configurations
            const configResponse = await fetch(`${supabaseUrl}/rest/v1/rate_limit_config?select=*&order=setting_name`, {
                headers: {
                    'Authorization': `Bearer ${serviceRoleKey}`,
                    'apikey': serviceRoleKey
                }
            });

            if (!configResponse.ok) {
                throw new Error('Failed to fetch rate limit configurations');
            }

            const configs = await configResponse.json();

            return new Response(JSON.stringify({
                data: configs
            }), {
                headers: { ...corsHeaders, 'Content-Type': 'application/json' }
            });

        } else if (req.method === 'PUT') {
            // Update rate limit configuration
            const { setting_name, setting_value, description, is_active } = await req.json();

            if (!setting_name || setting_value === undefined) {
                throw new Error('Setting name and value are required');
            }

            const updateResponse = await fetch(`${supabaseUrl}/rest/v1/rate_limit_config?setting_name=eq.${setting_name}`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `Bearer ${serviceRoleKey}`,
                    'apikey': serviceRoleKey,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                },
                body: JSON.stringify({
                    setting_value: parseInt(setting_value),
                    description: description || null,
                    is_active: is_active !== undefined ? is_active : true,
                    updated_at: new Date().toISOString()
                })
            });

            if (!updateResponse.ok) {
                const errorText = await updateResponse.text();
                throw new Error(`Failed to update configuration: ${errorText}`);
            }

            const updatedConfig = await updateResponse.json();

            return new Response(JSON.stringify({
                data: updatedConfig[0],
                message: 'Rate limit configuration updated successfully'
            }), {
                headers: { ...corsHeaders, 'Content-Type': 'application/json' }
            });

        } else if (req.method === 'POST') {
            // Create new rate limit configuration
            const { setting_name, setting_value, description, is_active } = await req.json();

            if (!setting_name || setting_value === undefined) {
                throw new Error('Setting name and value are required');
            }

            const createResponse = await fetch(`${supabaseUrl}/rest/v1/rate_limit_config`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${serviceRoleKey}`,
                    'apikey': serviceRoleKey,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                },
                body: JSON.stringify({
                    setting_name: setting_name,
                    setting_value: parseInt(setting_value),
                    description: description || null,
                    is_active: is_active !== undefined ? is_active : true
                })
            });

            if (!createResponse.ok) {
                const errorText = await createResponse.text();
                throw new Error(`Failed to create configuration: ${errorText}`);
            }

            const newConfig = await createResponse.json();

            return new Response(JSON.stringify({
                data: newConfig[0],
                message: 'Rate limit configuration created successfully'
            }), {
                headers: { ...corsHeaders, 'Content-Type': 'application/json' }
            });

        } else {
            throw new Error('Method not allowed');
        }

    } catch (error) {
        console.error('Admin rate limits error:', error);

        const errorResponse = {
            error: {
                code: 'ADMIN_RATE_LIMITS_FAILED',
                message: error.message
            }
        };

        const statusCode = error.message.includes('Admin access required') ? 403 :
                          error.message.includes('Authentication required') || 
                          error.message.includes('Invalid authentication') ? 401 :
                          error.message.includes('Method not allowed') ? 405 : 500;

        return new Response(JSON.stringify(errorResponse), {
            status: statusCode,
            headers: { ...corsHeaders, 'Content-Type': 'application/json' }
        });
    }
});